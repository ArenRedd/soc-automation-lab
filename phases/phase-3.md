This is part three of the sock automation project update. In today's video, we are going to be configuring our Windows 11 virtual machine and start sending our sysmon telemetry over to our Wizaw manager. Then we'll create a custom detection rule looking for Mimikat's activity. Let's get started. To begin ingesting sysmon telemetry into Wazah, we do need to make a little bit of configuration changes on the virtual machine itself. So, I'm currently on my Windows 11 virtual machine. And what we want to do here is head over to where Wiz is currently installed. So, if we click on the file explorer, go over to this PC, go into your C drive, program files, x86, and then click into the osc. And what we are interested in is the osac.com file. So, this one right here. What I'll do is I'll copy this and I'll just paste this inside. I'm essentially just making a copy of my OSC configuration file just in case I accidentally mess something up and it no longer works. To configure our OSC configuration file, we need to open up Notepad as an administrator. From here, click on file, open, and let's navigate over to our C drive program files x86 OSAC- agent. And currently we don't see the OSC configuration and that is because we are currently filtering for text documents. Instead let's filter for all files. Scroll down and here we go. So this contains our configuration on how our agent is talking to our Wizaw manager. What I want to do is scroll down until we see log analysis. Currently we see that it is ingesting application events. it is ingesting security events where it is currently excluding these particular event ids. Now for this particular example because we are only interested in our sysmon data. I'm just going to go ahead and remove all of this. Uh I'll just keep one for reference actually just like that. And for the application I'm going to delete this. And let's open up event viewer. Head over to our sysmon events. Click on Microsoft Windows. Scroll all the way down over to Sysmon. For operational, you want to rightclick properties and you want to copy the full name. So that right there. Copy that. And we'll paste it in where application used to be. From there, I'll save it out. And any kind of configuration changes you make, you have to restart the service. So, open up services, type in W, click on WA, rightclick, and restart. Over to my host machine, I am currently under the Waza manager here. If I go over to Explorer and discover, we should be able to start seeing some Sysmon telemetry. And just to confirm, we can search for Sysmon. And if I expand any of the events from the top and scroll down, we should see the Oh, there you go. Microsoft Windows Sysmon. So, we can confirm that our configuration worked as expected. The next thing to do here is start generating our test mimic telemetry. So, I'll head back over to my Windows 11 virtual machine. And what we'll need to do here is disable Microsoft Defender. I'll type in Defender. Whoops. Defender and click into Windows security. Click on virus and threat protection. Go into manage settings under virus and threat protection settings. Toggle the real time protection from on to off. And let's do the same for cloud delivery protection, automatic samples, and tamper protection just in case. Go ahead and exit that out. Open up Microsoft Edge. Open a new tab. and I'll type in Mimikats GitHub. And the one that we want here is by Gentle Kiwi right here. I'll go under code, scroll down. We want to select this one right here where it says if you don't want to build it, binaries are available. I'll click on the link and we'll download this version here, mimikats_runk.zip, version 2.2.0. And it says, hey, mimikats_runk.zip was blocked. Okay, what we can do is click on the three dots and select keep. And it provides us with a warning saying that this app is unsafe. That is okay. Click on the drop down and keep anyway. Open that up, rightclick, and extract all. Extract. And we'll go into the x64 and open up a PowerShell window. So I'll hold shift, rightclick, open PowerShell window here. Now, for those that don't know what mimikats is, I would recommend that you either watch my older video or just simply research more about it, but essentially it can take your passwords. So, I'll type in mimikats, hit tab for autocomp completion and enter. So, Windows security says, "Hey, threat found." Okay, let me dismiss that. And let's jump back over to our wasah. From here, if I remove sysmon and type in mimicats, we are getting no results. And that is because we are currently under the index of Waz-alerts aka any alerts that were generated by Waz. Now, if I'm not seeing any events with Mimikats under this particular index, that just tells me that there is currently no alerts, which is why we're going to create our own custom alert. But before we do that, we need to make some configuration changes on the manager itself. Over to my SSH session within our Wizaw manager. I'm going to clear up the screen. And from here, I'm going to do what I did on the agent, which is make a copy of my OSC.com file just again in case I mess anything up. So, I'll copy the file, which is located under varacetc, and it's called osac.com. And I'll just create a copy over here. Now, I'm going to type in nano varacet. osac.com. And we want to change the log all from no to yes. And same for the JSON as well. I'll hold controll X Y to save and enter. Now remember anytime we make any kind of configuration changes, we need to restart the service. Wuzzah manager.service. Once the service has been restarted, let's head over to the directory of var oac logs archives because by enabling the log all capabilities, Waza is now logging everything under what is called an archive. And if we take a look at the archive.log, we can see some data here. So if I do a cat archives.log, we can get pretty much your raw data. And that is good news that we're seeing this data. The next thing is to start modifying our file beat configuration. I'll type in nano etsy filebe filebeat.yiml. And at the bottom if you take a look under archives it is currently enabled is set to false. I want to put this to true and then hold x y to save. enter systemct ctl restart file beat and then I'll hit tab for autocomp completion. Once that's good, we're pretty much done for the manager side of things within our SSH. So, let's go back over to the web browser. And from here, we need to create an index. So, a new index that is indexing. It's a lot of index, but indexing essentially the archive logs. To create a new index, you want to click on this hamburger icon and then click into dashboard management. Scroll down just a bit and then click into dashboard management. And over on the lefth hand side, we do have an option for index patterns, data sources, saved objects, and advanced settings. The one that we are interested in is the index patterns. Over on the top right, you want to click on create index pattern. And for the index name, we'll type in wuzza-archchives dash. And we see it right here. Let's go ahead and click on next step. For the time field, I am going to scroll down for timestamp. And I'll click on create index pattern. Now, if we head over to the hamburger icon again, click on discover, we should have a new index called archives, and we get some information here. Now, let's rerun our mimikats over to my virtual machine. If I type in ls, yeah, defender deleted my mimikats, but that's okay. Go back over to my downloads. Go ahead and just extract mimikats again. Extract. Replace these files. And inside of my PowerShell session, if I type in ls, I should see mimikats again. So, I'll type in mimikats.exe and execute that. That is my bad. I'm supposed to put in a dot backslash mimicats.exe. Okay, I cannot spell today. So, mimikats.exe. There you go. Going back over to my Wazot here. If I were to search for mimicats, I now see it under my WA archive index. The next thing I'm going to do is create a rule that will detect mimikat's execution. I'll click on the hamburger icon and scroll down to server management and click on rules. Over to the right, you want to select custom rules and we'll go ahead and edit this local rules.xml file. Now, I am essentially going to reuse the same rule that I created in the previous sock automation project. And this is essentially what it looks like. What I'm searching for is anytime that there is a original file named mimikats.exe exe and under the sysmon event one which is process creations then trigger this rule. I'll click on save at the top right corner and I'll restart the manager. All right, now that the manager has been restarted, let's go and trigger our rule. I am going to actually open up defender again just in case I am going to exclude our folder. So it's under manage settings. go into exclusions. And what we want to do is just go ahead and exclude the entire C drive. Exit that out. Hopefully now Defender will stop deleting my binary. All right, good. Now, let's go back over to my PowerShell session. Type in ls one more time. MC cats is there. Type in minmme. I'll hit the up arrow key and hit enter. This in theory should generate my rule that I just created. And if we head back over to the manager, let's go into the hamburger icon and go into discover. From here, if I type in mimikats, hey, we got one hit. Perfect. And we're under the alerts. So, we know for a fact that our custom rule triggered. And if I scroll down, where is my rule name? There it is. Rule description. Mimikat's usage detected.